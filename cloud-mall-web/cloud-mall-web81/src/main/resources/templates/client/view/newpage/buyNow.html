<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4">
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1226">
    <meta th:name="_csrf" th:content="${_csrf.token}"/>
    <!-- 默认的header name是X-CSRF-TOKEN -->
    <meta th:name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>云商城-商品详情</title>
    <!-- 引入图标库-->
    <link href="http://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!--bootstrap-->
    <link rel="stylesheet" th:href="@{/static/resource/css/lib/bootstrap.min.css}"/>
    <!--    引入alibaba iconfont-->
    <link rel="stylesheet" href="//at.alicdn.com/t/font_2608271_v7p87hrx9q.css">

    <!--css-->
    <link rel="stylesheet" th:href="@{/static/resource/css/reset.css}"/>
    <link rel="stylesheet" th:href="@{/static/resource/css/index.css}"/>
    <link rel="stylesheet" th:href="@{/static/resource/css/cart.css}"/>
    <link rel="stylesheet" th:href="@{/static/resource/css/home.css}"/>
    <link rel="stylesheet" th:href="@{/static/resource/css/order.css}"/>
    <link rel="stylesheet" th:href="@{/static/resource/css/common/common.css}"/>
    <link rel="stylesheet" th:href="@{/static/js/directives/css/search.css}"/>
    <link rel="stylesheet" th:href="@{/static/js/directives/css/focusImg.css}"/>
    <link rel="stylesheet" th:href="@{/static/js/directives/css/focusImgMult.css}"/>
    <link rel="stylesheet" th:href="@{/static/js/directives/css/ulBox2.css}"/>


    <!--    layui-->
    <link rel="stylesheet" th:href="@{/static/layui/css/layui.css}">

</head>

<style>
    * {
        box-sizing: border-box;
    }


    div.search {
        padding: 30px 0;
    }

    form {
        position: relative;
        width: 300px;
        margin: 0 auto;
    }

    input, button {
        border: none;
        outline: none;
    }

    input {
        width: 100%;
        height: 42px;
        padding-left: 13px;
    }

    button {
        height: 42px;
        width: 42px;
        cursor: pointer;
        position: absolute;
    }

    /*搜索框6*/
    .bar6 input {
        border: 2px solid #c5464a;
        border-radius: 5px;
        background: transparent;
        top: 0;
        right: 0;
    }

    .bar6 button {
        background: #c5464a;
        border-radius: 0 5px 5px 0;
        width: 60px;
        top: 0;
        right: 0;
    }

    .bar6 button:before {
        content: "\f002";
        font-family: FontAwesome;
        font-size: 13px;
        color: #F9F0DA;
    }

    .search input {
        height: 42px;
    }


    ul, ol {
        list-style: none;
    }

    input, button {
        outline: none;
        border: none;
    }

    a {
        text-decoration: none;
    }

    .clearfix::before,
    .clearfix::after {
        content: "";
        height: 0;
        line-height: 0;
        display: block;
        visibility: hidden;
    }

    .clearfix::after {
        clear: both;
    }

    .product li {
        float: left;
        width: 234px;
        height: 246px;
        padding: 34px 0 20px;
        z-index: 1;
        margin-left: 14px;
        margin-bottom: 35px;
        background: #fff;
        -webkit-transition: all .2s linear;
        transition: all .2s linear;
        position: relative;
    }


    .pro-img a {
        width: 100%;
        height: 100%;
    }

    .pro-img img {
        display: block;
        width: 100%;
        height: 100%;
    }

    .product li h3 {
        margin: 0 10px;
        font-size: 14px;
        font-weight: 400;
        text-align: center;
    }

    .product li h3 a {
        color: #333;
    }


    .price del {
        color: #b0b0b0;
    }


    .review a {
        color: #757575;
        display: block;
        padding: 8px 30px;
        outline: 0;
    }

    .review a span {
        display: block;
        margin-bottom: 5px;
        color: #fff;
    }

    .product li:hover {
        -webkit-box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        -webkit-transform: translate3d(0, -2px, 0);
        transform: translate3d(0, -2px, 0);
    }

    .product li:hover .review {
        opacity: 1;
        height: 76px;
    }


    /*    */
    #box {
        width: 100%;
        height: 880px;
    }

    #content {
        width: 1226px;
        height: 860px;
        margin: 0 auto;
    }

    #left {
        margin-top: 3%;
        width: 500px;
        height: 410px;
        float: left;
    }

    #top {

        width: 100%;
        height: 76.8px;

    }

    #top ul li {

        float: left;
        width: 160px;
        height: 40px;
        text-align: center;
        list-style: none;
        line-height: 80px;
    }

    #top ul li a {

        text-decoration: none;
    }

    #big {
        width: 500px;
        height: 350px;
        float: left;
    }

    #small {
        width: 500px;
        height: 60px;
        float: left;
    }


    #right {
        margin-top: 3%;
        width: 550px;
        height: 650px;
        float: left;
        margin-left: 10%;
    }

    #title {
        width: 100%;
        height: 60px;
    }

    #productname {

        font-size: 20px;
        margin-top: 15px;

    }

    #price {
        margin-left: 16px;
        font-size: 20px;
        margin-top: 15px;
        color: #ff6700;
    }

    #version {

        width: 100%;
        height: 520px;
    }

    .versioninfo {
        width: 100%;
        height: 210px;

    }

    /* 默认未被选中样式*/
    .notClicked {

        width: 47%;
        height: 50px;
        float: left;
        list-style: none;
        text-align: center;
        border: 1px solid #e3e3e3;
        line-height: 50px;
        margin-right: 13px;
        margin-bottom: 13px;
    }

    /* 被选中样式*/
    .clicked {

        width: 47%;
        height: 50px;
        float: left;
        list-style: none;
        text-align: center;
        border: 1px solid #FFA500;
        line-height: 50px;
        margin-right: 13px;
        margin-bottom: 13px;
    }


    #Finally {

        width: 100%;
        height: 100px;

    }


</style>

<body>
<!-- jquery.js angular.js-->
<script th:src="@{/static/resource/lib/jquery.min.js}"></script>
<script th:src="@{/static/resource/lib/angular.js}"></script>

<!--头部工具栏-->
<div class="topbar">
    <div class="container">
        <div class="topbar_nav fl">
            <ul>
                <li><a href="https://www.jd.com/">京东商城</a></li>
                <li><a href="https://www.taobao.com/">淘宝商城</a></li>
                <li><a href="https://www.mi.com">小米商城</a></li>
                <li><a href="https://gitee.com/youzhengjie/cloud-mall">项目链接</a></li>
            </ul>
        </div>
        <div class="topbar_cart fr">
            <a href="/web/cart/tocart">购物车</a>
        </div>
        <div class="topbar_info fr">
            <form name="logoutform" th:action="@{/web/logout/logout}" method="post"></form>
            <a class="nav-link" th:href="@{/web/login/toregister}">注册</a>
            <a class="nav-link" sec:authorize="isAnonymous()" th:href="@{/web/login/toLoginPage}">登录</a>
            <a class="nav-link" sec:authorize="isAuthenticated()"
               href="javascript:document.logoutform.submit();">
                退出
            </a>
        </div>
    </div>
</div>


<!--  商品详情-->

<div id="box">


    <div id="content">

        <div id="top">

            <ul>
                <li><a href="#">小米6</a></li>
                <li><a href="#">小米note3</a></li>
                <li><a href="#">iPhone 13</a></li>
                <li><a href="#">红米note3</a></li>
                <li><a href="#">iqoo 8</a></li>
                <li><a href="#">小米11</a></li>
            </ul>


        </div>


        <div id="left">

            <div id="big">

                <img th:src="'/static/img/nav/'+${product.img}+'.jpg'" style="width: 500px;height: 350px">

            </div>

<!--            缩略图待实现-->
            <div id="small">


            </div>
        </div>


        <div id="right">


            <div id="title">

                <div id="productname">
                    购买[[${product.name}]]
                    <span id="price">
  		 				[[${product.price}]]起
  		 			</span>
                </div>


            </div>
            <span style="color: red;">温馨提示：产品是否购买成功，以最终下单为准哦，请尽快结算!</span>
            <div id="version">

                <div class="versioninfo" th:each="order:${#numbers.sequence(1,count)}">
                    <span th:text="${order}"></span>
                    <span th:text="${versionInfoFallbackFeign.selectVersionInfoTitle(product.productId,order)}"></span>
                    <span style="color: #b0b0b0;font-size: 14px;"
                          th:text="${versionInfoFallbackFeign.selectVersionInfoDesc(product.productId,order)}"></span>
                    <ul th:id="'vul'+${order}">
                        <li class="notClicked" th:id="'vli'+${versioninfo.versionId}" th:each="versioninfo:${versionInfoFallbackFeign.selectVersionInfoByPidAndOrder(product.productId,order)}"
                            th:text="${versioninfo.getName()}" th:onclick="pushSku(this,[[${order}]],[[${versioninfo.versionId}]])">
                        </li>
                    </ul>
                </div>

            </div>

            <div id="Finally">

                <p>您选择了以下产品</p>
                <p id="productInfos" style="color: cornflowerblue;">[[${product.getName()}]]</p>
                <button onclick="pushCart()" class="btn btn-warning" style="color: black">放入购物车</button>
            </div>


        </div>

    </div>

</div>

<!---->


<!-- buy-choose-box END -->
<hr/>
<div class="container">
    <div class="pro-detail-box">
        <div class="section section-image is-visible">
            <a href="#"><img src="/static/img/mi5/mi5-shenruliaojie.jpg"></a>
        </div>
    </div>
</div>


<!--footer-->
<footer class="footer">
    <div class="container">
        <div class="footer_service">
            <ul class="clearfix">
                <li><a href="">1小时快修服务</a></li>
                <li><a href="">7天无理由退货</a></li>
                <li><a href="">30天免费换货</a></li>
                <li><a href="">满200元包邮</a></li>
                <li><a href="">520余家售后网点</a></li>
            </ul>
        </div>

        <div class="footer_link clearfix">
            <dl>
                <dt>帮助中心</dt>
                <dd>购物指南</dd>
                <dd>支付方式</dd>
                <dd>配送方式</dd>
            </dl>
            <dl>
                <dt>帮助中心</dt>
                <dd>购物指南</dd>
                <dd>支付方式</dd>
                <dd>配送方式</dd>
            </dl>
            <dl>
                <dt>帮助中心</dt>
                <dd>购物指南</dd>
                <dd>支付方式</dd>
                <dd>配送方式</dd>
            </dl>
            <dl>
                <dt>帮助中心</dt>
                <dd>购物指南</dd>
                <dd>支付方式</dd>
                <dd>配送方式</dd>
            </dl>
            <dl>
                <dt>帮助中心</dt>
                <dd>购物指南</dd>
                <dd>支付方式</dd>
                <dd>配送方式</dd>
            </dl>
            <dl>
                <dt>帮助中心</dt>
                <dd>购物指南</dd>
                <dd>支付方式</dd>
                <dd>配送方式</dd>
            </dl>

            <div class="footer_contact">
                <p class="phone">18420163207</p>

                <p><span style="">周一至周日 8:00-18:00</span>
                    <span style="display:none;">2月7日至13日服务时间 7:00-18:00</span><br>（仅收市话费）</p>
                <a rel="nofollow" class="btn btn-primary btn-small" href="#">24小时在线客服</a>
            </div>
        </div>

    </div>

    <div class="footer_site">
        <div class="container">
            <div class="cart_log">
                <a href="" title="云商城"></a>
            </div>
            <div>
                <p>云商城项目由本人自己完成,如有不足,请指正！</p>
            </div>
        </div>
    </div>
</footer>


</body>


<script th:inline="javascript">

    // 获取<meta>标签中封装的_csrf信息 ,否则会请求403
    var token = $("meta[name='_csrf']").attr("content");
    var header = $("meta[name='_csrf_header']").attr("content");
    var headers = {"X-CSRF-TOKEN": token}

    //js提交表单
    function submitData() {
        document.getElementById("form").submit();
    }

    var size=[[${count}]];

    var skuarr=new Array(size); //存放sku的id的数组

    //例如order=1的存放在skuarr[0]中


    function pushSku(elem,orderid,skuid) {
        
        //放入skuarr
        skuarr[orderid-1]=skuid;

        let clickElem = document.getElementById(elem.id);//获取被点击的对象

        let parentNode = document.getElementById(elem.id).parentNode; //获取被点击对象的父节点

        let oldClick=document.querySelectorAll('#'+parentNode.id+' > li.clicked')[0];

        if(oldClick==null)
        {
            clickElem.classList.remove('notClicked');//移除未被点击样式
            clickElem.classList.add('clicked'); //添加被点击样式

        }else {

            oldClick.classList.remove('clicked');//移除旧的被点击样式
            oldClick.classList.add('notClicked');//添加旧的未被点击样式

            clickElem.classList.remove('notClicked');//移除未被点击样式
            clickElem.classList.add('clicked');
        }

        var productid=[[${product.productId}]]; //当前商品id
        //每次切换属性都要刷新一下价格
        $.ajax({
            url: "/web/versionInfo/selectPriceByversionId",
            data: {
                "skuarr": skuarr,
                "productid": productid
            },
            type: "GET",
            success: function (data) {
                document.getElementById('price').innerText=data+'元';
            }
        })

        //每次切换属性都要刷新一下购买产品信息
        $.ajax({
            url: "/web/versionInfo/selectNameByversionId",
            data: {
                "skuarr": skuarr,
                "productid": productid
            },
            type: "GET",
            success: function (data) { //ajax不要直接返回字符串，可以用JSONobject封装，不然会乱码
                document.getElementById('productInfos').innerText=data.name;
            }
        })


    }
    //放入购物车
    function pushCart() {
        //一次校验 是否可以放入购物车
        var boolean=1; //默认为1就是能买，0不可以买
        for (var i=0;i<skuarr.length;++i)
        {
            if(skuarr[i]==null)
            {
                boolean=0; //此时不能买，因为必选选项没有选完
                break;
            }
        }
        if(boolean==1) //可以放入购物车
        {
            var productid=[[${product.productId}]]; //当前商品id
            $.ajax({
                url: "/web/cart/pushCart",
                data: {
                    "skuarr": skuarr,
                    "productid": productid
                },
                type: "POST",
                dateType: 'json',
                headers:headers,
                success: function (data) {
                    if(data.code==200)
                    {
                        alert('商品放入购物车成功');
                    }else if(data.code==404)
                    {
                        alert('商品放入购物车失败');
                    }

                }
            })
        }else {
            alert('商品放入购物车失败')
        }

    }


    /*单击出现爱心特效*/
    (function (window, document, undefined) {
        var hearts = [];
        window.requestAnimationFrame = (function () {
            return window.requestAnimationFrame ||
                window.webkitRequestAnimationFrame ||
                window.mozRequestAnimationFrame ||
                window.oRequestAnimationFrame ||
                window.msRequestAnimationFrame ||
                function (callback) {
                    setTimeout(callback, 1000 / 60);
                }
        })();
        init();

        function init() {
            css(".heart{width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: absolute;}.heart:after{top: -5px;}.heart:before{left: -5px;}");
            attachEvent();
            gameloop();
        }

        function gameloop() {
            for (var i = 0; i < hearts.length; i++) {
                if (hearts[i].alpha <= 0) {
                    document.body.removeChild(hearts[i].el);
                    hearts.splice(i, 1);
                    continue;
                }
                hearts[i].y--;
                hearts[i].scale += 0.004;
                hearts[i].alpha -= 0.013;
                hearts[i].el.style.cssText = "left:" + hearts[i].x + "px;top:" + hearts[i].y + "px;opacity:" + hearts[i].alpha + ";transform:scale(" + hearts[i].scale + "," + hearts[i].scale + ") rotate(45deg);background:" + hearts[i].color;
            }
            requestAnimationFrame(gameloop);
        }

        function attachEvent() {
            var old = typeof window.onclick === "function" && window.onclick;
            window.onclick = function (event) {
                old && old();
                createHeart(event);
            }
        }

        function createHeart(event) {
            var d = document.createElement("div");
            d.className = "heart";
            hearts.push({
                el: d,
                x: event.clientX - 5,
                y: event.clientY - 5,
                scale: 1,
                alpha: 1,
                color: randomColor()
            });
            document.body.appendChild(d);
        }

        function css(css) {
            var style = document.createElement("style");
            style.type = "text/css";
            try {
                style.appendChild(document.createTextNode(css));
            } catch (ex) {
                style.styleSheet.cssText = css;
            }
            document.getElementsByTagName('head')[0].appendChild(style);
        }

        function randomColor() {
            return "rgb(" + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + ")";
        }
    })(window, document);
</script>


</html>